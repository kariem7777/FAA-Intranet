<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart - FAA Intranet</title>
    <!-- Bootstrap 5.3.2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Tajawal:wght@300;400;500;700;800&family=Dubai&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        h1 {
            font-size: 2.5rem !important;

            line-height: 1.2 !important;
        }

        h2 {
            font-size: 2rem !important;

            line-height: 1.3 !important;
        }

        h3 {
            font-size: 1.5rem !important;
            font-weight: 500 !important;
            line-height: 1.4 !important;
        }

        h4 {
            font-size: 1.25rem !important;
            font-weight: 500 !important;
            line-height: 1.4 !important;
        }

        h5 {
            font-size: 1.125rem !important;
            font-weight: 400 !important;
            line-height: 1.5 !important;
        }

        h6 {
            font-size: 1rem !important;
            font-weight: 400 !important;
            line-height: 1.5 !important;
        }

        p {
            font-size: 1rem !important;
            line-height: 1.6 !important;
        }

        a {
            text-decoration: none;
            transition: color 0.2s ease;
        }

        button {
            font-family: inherit !important;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: #908e81 #f1f1f1;
            font-family: "Dubai", "Tajawal", sans-serif;
        }

        .custom-container {
            max-width: 95vw;
            margin: auto;
        }

        .shadow-lg {
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -4px rgba(0, 0, 0, 0.1) !important;
        }

        .border {
            border: 1px solid #E5E5E5 !important;
        }

        :root {
            --faa-red: #ec2227;
            --faa-dark-red: #7B282D;
            --font-sans: 'Dubai', 'Tajawal', 'Inter', system-ui, -apple-system, sans-serif;
            --color-gray-50: #f8f9fa;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-900: #111827;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-gray-50);
            color: var(--color-gray-900);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 500;
        }

        /* Navbar Area */
        .nav-header {
            padding: 1rem 2rem;
            background: white;
            border-bottom: 1px solid var(--color-gray-200);
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        /* Split Layout */
        .split-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: calc(100vh - 72px);
        }

        /* Left Sidebar - Tree */
        .tree-sidebar {
            width: 35%;
            min-width: 320px;
            background: white;
            border-right: 1px solid var(--color-gray-200);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .tree-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-gray-200);
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .tree-content {
            padding: 1.5rem;
            padding-bottom: 2rem;
        }

        /* Node Cards */
        .node-card {
            border: 1px solid var(--color-gray-200);
            background: white;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .node-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: var(--color-gray-300);
        }

        .node-card.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .icon-box {
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Right Panel - Details */
        .details-panel {
            flex: 1;
            overflow-y: auto;
            background-color: var(--color-gray-50);
            position: relative;
        }

        .empty-state {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-direction: column;
        }

        /* Details Content */
        .details-content {
            padding: 2rem;
            margin: 0 auto;
            padding-bottom: 3rem;
        }

        .details-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .section-header-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: none;
            border: none;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-gray-900);
            cursor: pointer;
            transition: background 0.2s;
        }

        .section-header-btn:hover {
            background-color: var(--color-gray-50);
        }

        .section-content {
            padding: 1.5rem;
            padding-top: 0;
            border-top: 1px solid var(--color-gray-100);
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .badge-custom {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            border: 1px solid transparent;
        }

        /* Scrollbars */
        .tree-sidebar::-webkit-scrollbar,
        .details-panel::-webkit-scrollbar {
            width: 6px;
        }

        .tree-sidebar::-webkit-scrollbar-track,
        .details-panel::-webkit-scrollbar-track {
            background: var(--color-gray-100);
        }

        .tree-sidebar::-webkit-scrollbar-thumb,
        .details-panel::-webkit-scrollbar-thumb {
            background-color: var(--color-gray-300);
            border-radius: 3px;
        }

        /* Helper Classes */
        .separator {
            height: 1px;
            background-color: var(--color-gray-200);
            margin: 1rem 0;
            width: 100%;
        }

        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tree-group-label {
            font-size: 0.75rem;
            color: var(--color-gray-500);
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
            margin-top: 0;
        }

        .btn-link-custom {
            color: var(--faa-dark-red);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background 0.2s;
            background: transparent;
            border: none;
        }

        .btn-link-custom:hover {
            background-color: rgba(123, 40, 45, 0.1);
            color: var(--faa-dark-red);
        }

        .nested-tree {
            margin-left: 1.5rem;
            border-left: 2px solid var(--color-gray-200);
            padding-left: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            margin-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .chevron-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chevron-btn:hover {
            background-color: var(--color-gray-100);
        }

        /* Profile Styles */
        .profile-header-img {
            width: 96px;
            height: 96px;
            object-fit: cover;
            border: 4px solid var(--color-gray-100);
            border-radius: 50%;
        }

        /* Custom Colors matching Tailwind */
        .bg-blue-50 {
            background-color: #eff6ff !important;
        }

        .text-blue-600,
        .text-blue-700 {
            color: #2563eb !important;
        }

        .border-blue-200 {
            border-color: #bfdbfe !important;
        }

        .border-blue-500 {
            border-color: #3b82f6 !important;
        }

        .bg-purple-50 {
            background-color: #faf5ff !important;
        }

        .text-purple-600,
        .text-purple-700 {
            color: #9333ea !important;
        }

        .bg-green-50 {
            background-color: #f0fdf4 !important;
        }

        .text-green-600,
        .text-green-700 {
            color: #16a34a !important;
        }

        .border-green-200 {
            border-color: #bbf7d0 !important;
        }

        .bg-red-50 {
            background-color: #fef2f2 !important;
        }

        .text-red-600,
        .text-red-700 {
            color: #dc2626 !important;
        }

        .border-red-200 {
            border-color: #fecaca !important;
        }

        .bg-orange-50 {
            background-color: #fff7ed !important;
        }

        .text-orange-700 {
            color: #c2410c !important;
        }

        .border-orange-200 {
            border-color: #fed7aa !important;
        }

        .bg-yellow-50 {
            background-color: #fefce8 !important;
        }

        .text-yellow-700 {
            color: #a16207 !important;
        }

        .border-yellow-200 {
            border-color: #fef08a !important;
        }

        .bg-indigo-50 {
            background-color: #eef2ff !important;
        }

        .text-indigo-600,
        .text-indigo-700 {
            color: #4f46e5 !important;
        }

        .bg-pink-100 {
            background-color: #fce7f3 !important;
        }

        .text-pink-700 {
            color: #be185d !important;
        }

        .bg-teal-100 {
            background-color: #ccfbf1 !important;
        }

        .text-teal-700 {
            color: #0f766e !important;
        }

        .bg-cyan-100 {
            background-color: #cffafe !important;
        }

        .text-cyan-700 {
            color: #0e7490 !important;
        }

        .bg-purple-100 {
            background-color: #f3e8ff !important;
        }

        .bg-green-100 {
            background-color: #dcfce7 !important;
        }

        .bg-orange-100 {
            background-color: #ffedd5 !important;
        }

        /* Responsive Split View */
        @media (max-width: 991.98px) {
            body {
                height: auto;
                overflow: auto;
            }

            .split-container {
                flex-direction: column;
                height: auto;
            }

            .tree-sidebar {
                width: 100%;
                min-width: 0;
                height: 450px;
                border-right: none;
                border-bottom: 4px solid var(--color-gray-200);
            }

            .details-panel {
                height: auto;
                overflow: visible;
            }

            .details-content {
                padding: 1rem;
                padding-bottom: 2rem;
            }

            .profile-header-img {
                width: 72px;
                height: 72px;
            }
        }

        .leader-card-message {
            background-color: #EFF6FF;
            color: #374151;
            font-size: 1rem;
            border-color: #3b82f6 !important;
            border-radius: 0px 12px 12px 0px;
        }

        .champion-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease-in-out;
        }
    </style>
</head>

<body>

    <!-- Nav Header -->
    <div class="nav-header">
        <button class="btn-link-custom ms-0" onclick="window.location.href='HomePage.html'">
            <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
            <span>Back to Home</span>
        </button>
    </div>

    <div class="split-container">
        <!-- Sidebar -->
        <div class="tree-sidebar">
            <div class="tree-header">
                <h2 class="h5 mb-1 fw-semibold text-dark">Organization Chart</h2>
                <p class="small text-muted mb-0">Select any node to view details</p>
            </div>
            <div class="tree-content" id="treeRoot">
                <!-- Tree Injected via JS -->
            </div>
        </div>

        <!-- Details Panel -->
        <div class="details-panel" id="detailsPanel">
            <!-- Details Injected via JS -->
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- DATA ---

        const employeeProfileData = {
            about: {
                bio: 'Experienced professional with over 10 years in financial auditing and compliance. Passionate about delivering excellence and maintaining the highest standards of integrity.',
                social: { linkedin: 'linkedin.com/in/employee', twitter: '@employee' }
            },
            academic: [
                { degree: 'Master of Business Administration', institution: 'Dubai University', year: '2015' },
                { degree: 'Bachelor of Accounting', institution: 'UAE University', year: '2010' },
            ],
            certifications: [
                { name: 'Certified Public Accountant (CPA)', issuer: 'AICPA', year: '2016' },
                { name: 'Certified Internal Auditor (CIA)', issuer: 'IIA', year: '2017' },
            ],
            faaExperience: [
                { position: 'Senior Auditor', period: '2019 - Present', department: 'Operation Sector' },
                { position: 'Auditor', period: '2016 - 2019', department: 'Financial Sector' },
            ],
            previousExperience: [
                { company: 'KPMG Dubai', position: 'Audit Associate', period: '2013 - 2016' },
                { company: 'Deloitte', position: 'Junior Auditor', period: '2010 - 2013' },
            ],
            achievements: [
                { title: 'Employee of the Year 2021', description: 'Recognized for outstanding performance' },
                { title: 'Excellence Award', description: 'Best audit report of 2020' },
            ],
            skills: ['Financial Analysis', 'Risk Assessment', 'Compliance Review', 'Data Analytics', 'Report Writing'],
            languages: [
                { language: 'Arabic', level: 'Native' },
                { language: 'English', level: 'Fluent' },
                { language: 'French', level: 'Intermediate' },
            ],
        };

        const treeData = [
            { id: 'ruler', title: 'Ruler of Dubai', icon: 'crown', color: '#ec2227', type: 'leadership', description: 'Supreme Leadership' },
            { id: 'chairman', title: 'Chairman', icon: 'user', color: '#ec2227', type: 'leadership', description: 'Executive Chairman' },
            {
                id: 'dg', title: 'Director General', icon: 'building-2', color: '#7b282d', type: 'leadership',
                leader: { name: 'Ahmed Al Mansouri', title: 'Director General', image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400', message: 'Leading the Financial Audit Authority with integrity, transparency, and excellence in governance.', mission: 'To ensure the highest standards of financial accountability and audit excellence across all government entities in Dubai.' },
                overview: { description: 'The Director General oversees all audit operations, compliance frameworks, and strategic initiatives.', focusAreas: ['Strategic Leadership', 'Governance Excellence', 'Audit Quality', 'Stakeholder Relations'] },
                employees: [
                    { id: 'e1', name: 'Sarah Johnson', role: 'Executive Assistant', image: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400', since: '2019', email: 'sarah.j@faa.gov.ae', phone: '+971-4-XXX-XXXX' },
                    { id: 'e2', name: 'Mohammed Hassan', role: 'Chief of Staff', image: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400', since: '2017', email: 'mohammed.h@faa.gov.ae', phone: '+971-4-XXX-XXXX' },
                ],
                committees: [
                    { id: 'c1', name: 'Executive Committee', purpose: 'Strategic decision making', chairperson: 'Ahmed Al Mansouri', coordinator: 'Mohammed Hassan', members: [{ name: 'Tariq Al Zarooni', role: 'IT' }, { name: 'Reem Al Mansouri', role: 'HR' }] }
                ]
            },
            {
                id: 'dg-office', title: 'Director General Office', icon: 'building-2', color: '#5b9bd5', type: 'office',
                leader: { name: 'Fatima Al Zarooni', title: 'Head of Director General Office', image: 'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?w=400', message: 'Supporting the Director General in strategic planning.', mission: 'To provide comprehensive administrative and strategic support.' },
                overview: { description: 'Coordinates all executive functions and manages strategic communications.', focusAreas: ['Executive Support', 'Strategic Planning', 'Communications'] }
            },
            {
                id: 'deputy-dg', title: 'Deputy Director General', icon: 'user-cog', color: '#543671', type: 'office',
                leader: { name: 'Khalid Al Maktoum', title: 'Deputy Director General', image: 'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=400', message: 'Driving operational excellence.', mission: 'To support the Director General in achieving organizational objectives.' },
                overview: { description: 'Assists in overseeing daily operations and major audit initiatives.', focusAreas: ['Operations Management', 'Quality Control', 'Team Leadership'] }
            },
            {
                id: 'operation-sector', title: 'Operation, Compliance & Performance Audit Sector', icon: 'file-check', color: '#d99694', type: 'sector',
                leader: { name: 'Hassan Al Blooshi', title: 'Sector Director', image: 'https://images.unsplash.com/photo-1556157382-97eda2d62296?w=400', message: 'Ensuring comprehensive audit coverage.', mission: 'To deliver high-quality audits that enhance transparency.' },
                overview: { description: 'Conducts audits of government entities, free zones, and financial institutions.', focusAreas: ['Compliance Audits', 'Performance Reviews', 'Risk Assessment'] },
                kpis: [{ id: 'k1', title: 'Audit Completion Rate', description: 'Percentage of scheduled audits completed', metric: '95%', target: '90%', status: 'exceeds', trend: 'up' }, { id: 'k2', title: 'Compliance Score', description: 'Average entity compliance score', metric: '94%', target: '92%', status: 'exceeds', trend: 'up' }],
                risks: {
                    strategic: [{ id: 'sr1', title: 'Regulatory Changes', description: 'New financial regulations impacting audit scope', level: 'High', mitigation: 'Regular training', mitigationRole: 'Compliance Head' }],
                    operational: [{ id: 'or1', title: 'Resource Constraints', description: 'Peak audit season staffing', level: 'Medium', mitigation: 'Outsourcing', mitigationRole: 'Resource Manager' }]
                },
                champions: [
                    { id: 'ch1', name: 'Hassan Al Blooshi', role: 'Audit Quality Champion', category: 'Quality', image: 'https://images.unsplash.com/photo-1556157382-97eda2d62296?w=400', categoryColor: '#7c3aed' },
                    { id: 'ch2', name: 'Hassan Al Blooshi', role: 'Audit Quality Champion', category: 'Quality', image: 'https://images.unsplash.com/photo-1556157382-97eda2d62296?w=400', categoryColor: '#7c3aed' },
                    { id: 'ch3', name: 'Hassan Al Blooshi', role: 'Audit Quality Champion', category: 'Quality', image: 'https://images.unsplash.com/photo-1556157382-97eda2d62296?w=400', categoryColor: '#7c3aed' },
                ]
            },
            { id: 'ports', title: 'Ports & Free Zones Audit', icon: 'landmark', color: '#5b9bd5', type: 'department', parentId: 'operation-sector', overview: { description: 'Specialized audits of port authorities.', focusAreas: ['Port Operations'] } },
            { id: 'real-estate', title: 'Real Estate & Hospitality Audit', icon: 'building', color: '#5b9bd5', type: 'department', parentId: 'operation-sector', overview: { description: 'Audits property development and hotels.', focusAreas: ['Real Estate', 'Hotels'] } },
            { id: 'energy', title: 'Energy & Industry Audit', icon: 'layers', color: '#5b9bd5', type: 'department', parentId: 'operation-sector', overview: { description: 'Audits energy companies and utilities.', focusAreas: ['Energy', 'Utilities'] } },

            {
                id: 'financial-sector', title: 'Financial Statement & Specialized Audit Sector', icon: 'calculator', color: '#d99694', type: 'sector',
                leader: { name: 'Dr. Maryam Al Hashemi', title: 'Sector Director', image: 'https://images.unsplash.com/photo-1551836022-deb4988cc6c0?w=400', message: 'Leading financial audits with precision.', mission: 'To ensure accurate financial reporting.' },
                overview: { description: 'Specializes in financial statement audits and construction projects.', focusAreas: ['Financial Audits', 'IT Systems', 'Construction Projects'] }
            },
            { id: 'financial-statement', title: 'Financial Statement Audit', icon: 'file-check', color: '#5b9bd5', type: 'department', parentId: 'financial-sector', overview: { description: 'Reviews financial statements.', focusAreas: ['IFRS Compliance'] } },
            { id: 'construction', title: 'Construction & Infrastructure Audit', icon: 'building', color: '#5b9bd5', type: 'department', parentId: 'financial-sector', overview: { description: 'Audits construction projects.', focusAreas: ['Construction', 'Contracts'] } },
            { id: 'it-audit', title: 'Information Systems Audit', icon: 'layers', color: '#5b9bd5', type: 'department', parentId: 'financial-sector', overview: { description: 'Conducts IT audits.', focusAreas: ['Cybersecurity', 'IT Controls'] } },

            {
                id: 'corporate-sector', title: 'Corporate Support Sector', icon: 'users', color: '#d99694', type: 'sector',
                leader: { name: 'Ibrahim Al Shamsi', title: 'Sector Director', image: 'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?w=400', message: 'Providing comprehensive support services.', mission: 'To deliver exceptional HR and IT support.' },
                overview: { description: 'Manages HR, Finance, IT, and Legal affairs.', focusAreas: ['HR', 'IT', 'Legal', 'Finance'] },
                committees: [
                    { id: 'com30', name: 'Corporate Services Committee', purpose: 'Coordinate corporate support', chairperson: 'Ibrahim Al Shamsi', coordinator: 'Reem Al Mansouri', members: [{ name: 'Tariq Al Zarooni', role: 'IT Rep' }] }
                ]
            },
            {
                id: 'hr', title: 'Human Resources', icon: 'users', color: '#5b9bd5', type: 'department', parentId: 'corporate-sector',
                leader: { name: 'Shaikha Al Mazrouei', title: 'HR Dept Head', image: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400', message: 'Building a talented workforce.', mission: 'Attract, develop, and retain top talent.' },
                overview: { description: 'Manages recruitment, training, and employee relations.', focusAreas: ['Recruitment', 'L&D', 'Relations'] },
                employees: [
                    { id: 'e70', name: 'Shaikha Al Mazrouei', role: 'Head', image: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400', since: '2013', email: 's.mazrouei@faa.gov.ae', phone: '+971-4-123-4567' },
                    { id: 'e71', name: 'Maryam Al Suwaidi', role: 'Recruitment Mgr', image: 'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=400', since: '2015', email: 'm.suwaidi@faa.gov.ae', phone: '+971-4-123-4568' }
                ],
                champions: [
                    { id: 'c15', name: 'Shaikha Al Mazrouei', role: 'People Champion', category: 'People', image: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400', categoryColor: '#ec4899' }
                ],
                kpis: [
                    { id: 'kpi24', title: 'Employee Satisfaction', description: 'Satisfaction score', metric: '92%', target: '88%', status: 'exceeds', trend: 'up' }
                ],
                risks: {
                    strategic: [{ id: 'sr13', title: 'Talent Retention', description: 'High competition for skilled staff', level: 'Medium', mitigation: 'Retention Program', mitigationRole: 'HR Head' }]
                },
                committees: [
                    { id: 'com13', name: 'HR Development Committee', purpose: 'Review HR policies', chairperson: 'Shaikha Al Mazrouei', coordinator: 'TBD', members: [{ name: 'Training Specialist', role: 'L&D Expert' }] }
                ]
            },
            { id: 'finance-proc', title: 'Finance & Procurement', icon: 'dollar-sign', color: '#5b9bd5', type: 'department', parentId: 'corporate-sector', overview: { description: 'Handles budgeting and procurement.', focusAreas: ['Budget', 'Vendors'] } },

            { id: 'strategy', title: 'Strategy Department', icon: 'target', color: '#8cd4e4', type: 'strategy', leader: { name: 'Sara Al Nuaimi', title: 'Head of Strategy', image: 'https://images.unsplash.com/photo-1589156229687-496a31ad1d1f?w=400', message: 'Shaping the future through strategic planning.', mission: 'To develop and implement strategies.' }, overview: { description: 'Develops long-term strategic plans.', focusAreas: ['Strategy', 'KPIs'] } },
            { id: 'quality', title: 'Professional Practice & Quality', icon: 'award', color: '#908e81', type: 'strategy', leader: { name: 'Dr. Ahmed Al Zaabi', title: 'Quality Director', image: 'https://images.unsplash.com/photo-1568602471122-7832951cc4c5?w=400', message: 'Maintaining highest standards of audit quality.', mission: 'To ensure international standards.' }, overview: { description: 'Ensures quality control.', focusAreas: ['QA', 'Methodology'] } },
        ];

        // --- STATE ---

        let state = {
            selectedId: null,
            expandedSectors: { 'operation-sector': false, 'financial-sector': false, 'corporate-sector': false },
            expandedSections: {
                about: false, academic: false, certifications: false, faaExperience: false, previousExperience: false, achievements: false, skills: false, languages: false,
                champions: true, kpis: true, risks: true, committees: true
            },
            showProfile: null
        };

        // --- ACTIONS ---

        function selectNode(id) {
            state.selectedId = id;
            state.showProfile = null; // Reset profile view
            renderTree();
            renderDetails();
        }

        function toggleSector(e, id) {
            e.stopPropagation();
            state.expandedSectors[id] = !state.expandedSectors[id];
            renderTree();
        }

        function toggleSection(section) {
            state.expandedSections[section] = !state.expandedSections[section];
            renderDetails();
        }

        function viewProfile(employeeId) {
            const node = treeData.find(n => n.id === state.selectedId);
            if (node && node.employees) {
                const emp = node.employees.find(e => e.id === employeeId);
                if (emp) {
                    state.showProfile = emp;
                    renderDetails();
                }
            }
        }

        function closeProfile() {
            state.showProfile = null;
            renderDetails();
        }

        // --- RENDERERS ---

        function renderTree() {
            const root = document.getElementById('treeRoot');
            let html = '';

            // Group: Leadership
            html += `<div class="d-flex flex-column gap-2 mb-4">`;
            treeData.filter(n => n.type === 'leadership').forEach(node => {
                html += renderNodeCard(node);
            });
            html += `</div><div class="separator"></div>`;

            // Group: Offices
            html += `<div class="tree-group-label">Executive Offices</div>`;
            html += `<div class="d-flex flex-column gap-2 mb-4">`;
            treeData.filter(n => n.type === 'office').forEach(node => {
                html += renderNodeCard(node);
            });
            html += `</div><div class="separator"></div>`;

            // Group: Sectors & Depts
            html += `<div class="tree-group-label">Sectors & Departments</div>`;
            html += `<div class="d-flex flex-column gap-3 mb-4">`;
            treeData.filter(n => n.type === 'sector').forEach(sector => {
                html += `<div>`;
                const isExpanded = state.expandedSectors[sector.id];
                html += renderSectorCard(sector, isExpanded);

                if (isExpanded) {
                    const depts = treeData.filter(n => n.type === 'department' && n.parentId === sector.id);
                    if (depts.length > 0) {
                        html += `<div class="nested-tree">`;
                        depts.forEach(dept => {
                            html += renderNodeCard(dept, true);
                        });
                        html += `</div>`;
                    }
                }
                html += `</div>`;
            });
            html += `</div><div class="separator"></div>`;

            // Group: Strategy
            html += `<div class="tree-group-label">Strategy & Quality</div>`;
            html += `<div class="d-flex flex-column gap-2">`;
            treeData.filter(n => n.type === 'strategy').forEach(node => {
                html += renderNodeCard(node);
            });
            html += `</div>`;

            root.innerHTML = html;
            lucide.createIcons();
        }

        function renderNodeCard(node, isSmall = false) {
            const isActive = state.selectedId === node.id;

            return `
                ${!isSmall && node.type !== 'department' ? `<div class="d-flex align-items-center gap-2">` : ''}
                ${!isSmall && node.type === 'leadership' ? `<div style="width: 4px; height: 32px; background-color: #e5e7eb;"></div>` : ''}
                
                <div class="node-card ${isActive ? 'active' : ''} flex-grow-1 ${isSmall ? 'p-2' : 'p-3'}" onclick="selectNode('${node.id}')">
                    <div class="icon-box" style="background-color: ${node.color}15;">
                        <i data-lucide="${node.icon}" style="color: ${node.color}; width: ${isSmall ? '14px' : '16px'}; height: ${isSmall ? '14px' : '16px'};"></i>
                    </div>
                    <div class="text-truncate-2 fs-6">
                        ${node.title}
                    </div>
                </div>
                
                ${!isSmall && node.type !== 'department' ? `</div>` : ''}
            `;
        }

        function renderSectorCard(node, isExpanded) {
            const isActive = state.selectedId === node.id;
            return `
                <div class="node-card ${isActive ? 'active' : ''} p-2 pe-1" onclick="selectNode('${node.id}')">
                    <div class="icon-box" style="background-color: ${node.color}15;">
                        <i data-lucide="${node.icon}" style="color: ${node.color}; width: 16px; height: 16px;"></i>
                    </div>
                    <div class="flex-grow-1 text-truncate-2 fs-6">
                        ${node.title}
                    </div>
                    <button class="chevron-btn" onclick="toggleSector(event, '${node.id}')">
                        <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" style="width: 16px; height: 16px; color: #6b7280;"></i>
                    </button>
                </div>
            `;
        }

        function renderDetails() {
            const panel = document.getElementById('detailsPanel');

            // Empty State
            if (!state.selectedId) {
                panel.innerHTML = `
                    <div class="empty-state">
                        <div class="mb-4 bg-white p-4 rounded-circle shadow-sm" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="building-2" class="text-secondary" style="width: 40px; height: 40px;"></i>
                        </div>
                        <h3 class="h4 text-dark mb-2">Select a Node</h3>
                        <p class="text-muted small" style="max-width: 300px;">Click on any sector, department, or office in the organization chart to view detailed information</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            // Get Data
            const node = treeData.find(n => n.id === state.selectedId);

            // PROFILE VIEW
            if (state.showProfile) {
                const p = state.showProfile;
                const d = employeeProfileData;

                panel.innerHTML = `
                    <div class="details-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                             <button class="btn btn-white border shadow-sm btn-sm d-flex align-items-center gap-2 rounded-3 text-muted" onclick="closeProfile()">
                                <i data-lucide="arrow-left" style="width: 14px;"></i> Back to Team
                            </button>
                        </div>
                       
                        <div class="details-card p-4 rounded-4 shadow-sm bg-white mb-3">
                            <div class="d-flex flex-column flex-md-row gap-4 align-items-center align-items-md-start">
                                <img src="${p.image}" class="rounded-circle profile-header-img" style="width: 80px; height: 80px; object-fit: cover;">
                                <div class="flex-grow-1 text-center text-md-start">
                                    <h2 class="h4 fw-bold mb-1 text-dark">${p.name}</h2>
                                    <p class="text-muted mb-3 small">${p.role}</p>
                                    
                                    <div class="d-flex flex-wrap gap-3 small text-muted mb-4 justify-content-center justify-content-md-start">
                                        <div class="d-flex align-items-center gap-1">
                                            <i data-lucide="calendar" style="width: 14px;"></i> Since ${p.since}
                                        </div>
                                        <div class="d-flex align-items-center gap-1">
                                            <i data-lucide="map-pin" style="width: 14px;"></i> Dubai, UAE
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2 justify-content-center justify-content-md-start">
                                        <button class="btn btn-sm btn-light border d-flex align-items-center gap-2 text-dark bg-white">
                                            <i data-lucide="mail" style="width: 14px; opacity: 0.6;"></i> ${p.email}
                                        </button>
                                        <button class="btn btn-sm btn-light border d-flex align-items-center gap-2 text-dark bg-white">
                                            <i data-lucide="phone" style="width: 14px; opacity: 0.6;"></i> ${p.phone}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 1. About -->
                        <div class="details-card p-0 rounded-4 shadow-sm bg-white mb-3">
                            <button class="section-header-btn p-3 w-100 text-start border-0 bg-transparent d-flex justify-content-between align-items-center" onclick="toggleSection('about')">
                                <div class="d-flex align-items-center gap-3">
                                    <i data-lucide="user" class="text-secondary" style="width: 18px;"></i>
                                    <span class="fw-normal text-dark">About & Social Profile</span>
                                </div>
                                <i data-lucide="${state.expandedSections.about ? 'chevron-up' : 'chevron-down'}" style="width: 16px;" class="text-secondary"></i>
                            </button>
                            ${state.expandedSections.about ? `
                            <div class="p-4 pt-0 border-top-0">
                                <p class="small text-secondary mb-3">${d.about.bio}</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-2"><i data-lucide="linkedin" style="width: 14px;"></i> LinkedIn</button>
                                    <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-2"><i data-lucide="twitter" style="width: 14px;"></i> Twitter</button>
                                </div>
                            </div>` : ''}
                        </div>

                        <!-- 2. Academic -->
                        <div class="details-card p-0 rounded-4 shadow-sm bg-white mb-3">
                            <button class="section-header-btn p-3 w-100 text-start border-0 bg-transparent d-flex justify-content-between align-items-center" onclick="toggleSection('academic')">
                                <div class="d-flex align-items-center gap-3">
                                    <i data-lucide="graduation-cap" class="text-secondary" style="width: 18px;"></i>
                                    <span class="fw-normal text-dark">Academic Information</span>
                                </div>
                                <i data-lucide="${state.expandedSections.academic ? 'chevron-up' : 'chevron-down'}" style="width: 16px;" class="text-secondary"></i>
                            </button>
                            ${state.expandedSections.academic ? `
                            <div class="p-4 pt-0 border-top-0">
                                <div class="d-flex flex-column gap-3">
                                    ${d.academic.map((item, index) => `
                                        <div class="${index !== d.academic.length - 1 ? 'border-bottom pb-3' : ''}">
                                            <div class="fw-medium text-dark mb-1" style="font-size: 0.95rem;">${item.degree}</div>
                                            <div class="small text-muted">${item.institution} • ${item.year}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>

                        <!-- 3. Certifications -->
                        <div class="details-card p-0 rounded-4 shadow-sm bg-white mb-3">
                            <button class="section-header-btn p-3 w-100 text-start border-0 bg-transparent d-flex justify-content-between align-items-center" onclick="toggleSection('certifications')">
                                <div class="d-flex align-items-center gap-3">
                                    <i data-lucide="award" class="text-secondary" style="width: 18px;"></i>
                                    <span class="fw-normal text-dark">Professional Certifications</span>
                                </div>
                                <i data-lucide="${state.expandedSections.certifications ? 'chevron-up' : 'chevron-down'}" style="width: 16px;" class="text-secondary"></i>
                            </button>
                            ${state.expandedSections.certifications ? `
                            <div class="p-4 pt-0 border-top-0">
                                <div class="d-flex flex-column gap-3">
                                    ${d.certifications.map((item, index) => `
                                        <div class="${index !== d.certifications.length - 1 ? 'border-bottom pb-3' : ''}">
                                            <div class="fw-medium text-dark mb-1" style="font-size: 0.95rem;">${item.name}</div>
                                            <div class="small text-muted">${item.issuer} • ${item.year}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>

                         <!-- 4. FAA Experience -->
                        <div class="details-card p-0 rounded-4 shadow-sm bg-white mb-3">
                             <button class="section-header-btn p-3 w-100 text-start border-0 bg-transparent d-flex justify-content-between align-items-center" onclick="toggleSection('faaExperience')">
                                <div class="d-flex align-items-center gap-3">
                                    <i data-lucide="briefcase" class="text-secondary" style="width: 18px;"></i>
                                    <span class="fw-normal text-dark">FAA Experience</span>
                                </div>
                                <i data-lucide="${state.expandedSections.faaExperience ? 'chevron-up' : 'chevron-down'}" style="width: 16px;" class="text-secondary"></i>
                            </button>
                            ${state.expandedSections.faaExperience ? `
                            <div class="p-4 pt-0 border-top-0">
                                <div class="d-flex flex-column gap-3">
                                    ${d.faaExperience.map((item, index) => `
                                        <div class="${index !== d.faaExperience.length - 1 ? 'border-bottom pb-3' : ''}">
                                            <div class="fw-medium text-dark mb-1" style="font-size: 0.95rem;">${item.position}</div>
                                            <div class="small text-muted">${item.department} • ${item.period}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>

                         <!-- 5. Achievements -->
                        <div class="details-card p-0 rounded-4 shadow-sm bg-white mb-3">
                             <button class="section-header-btn p-3 w-100 text-start border-0 bg-transparent d-flex justify-content-between align-items-center" onclick="toggleSection('achievements')">
                                <div class="d-flex align-items-center gap-3">
                                    <i data-lucide="trophy" class="text-secondary" style="width: 18px;"></i>
                                    <span class="fw-normal text-dark">Achievements & Awards</span>
                                </div>
                                <i data-lucide="${state.expandedSections.achievements ? 'chevron-up' : 'chevron-down'}" style="width: 16px;" class="text-secondary"></i>
                            </button>
                            ${state.expandedSections.achievements ? `
                            <div class="p-4 pt-0 border-top-0">
                                <div class="d-flex flex-column gap-3">
                                    ${d.achievements.map((item, index) => `
                                        <div class="${index !== d.achievements.length - 1 ? 'border-bottom pb-3' : ''}">
                                            <div class="fw-medium text-dark mb-1" style="font-size: 0.95rem;">${item.title}</div>
                                            <div class="small text-muted">${item.description}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>

                        <!-- 6. Skills -->
                         <div class="details-card p-0 rounded-4 shadow-sm bg-white mb-3">
                             <button class="section-header-btn p-3 w-100 text-start border-0 bg-transparent d-flex justify-content-between align-items-center" onclick="toggleSection('skills')">
                                <div class="d-flex align-items-center gap-3">
                                    <i data-lucide="star" class="text-secondary" style="width: 18px;"></i>
                                    <span class="fw-normal text-dark">Skills & Competencies</span>
                                </div>
                                <i data-lucide="${state.expandedSections.skills ? 'chevron-up' : 'chevron-down'}" style="width: 16px;" class="text-secondary"></i>
                            </button>
                            ${state.expandedSections.skills ? `
                            <div class="p-4 pt-0 border-top-0">
                                <div class="d-flex flex-wrap gap-4">
                                     ${d.skills.map(skill => `<span class="small text-dark fw-medium">${skill}</span>`).join('')}
                                </div>
                            </div>` : ''}
                        </div>

                        <!-- 7. Languages -->
                        <div class="details-card p-0 rounded-4 shadow-sm bg-white mb-3">
                             <button class="section-header-btn p-3 w-100 text-start border-0 bg-transparent d-flex justify-content-between align-items-center" onclick="toggleSection('languages')">
                                <div class="d-flex align-items-center gap-3">
                                    <i data-lucide="languages" class="text-secondary" style="width: 18px;"></i>
                                    <span class="fw-normal text-dark">Languages</span>
                                </div>
                                <i data-lucide="${state.expandedSections.languages ? 'chevron-up' : 'chevron-down'}" style="width: 16px;" class="text-secondary"></i>
                            </button>
                            ${state.expandedSections.languages ? `
                            <div class="p-4 pt-0 border-top-0">
                                <div class="d-flex flex-column gap-3">
                                     ${d.languages.map((item, index) => `
                                        <div class="d-flex justify-content-between align-items-center ${index !== d.languages.length - 1 ? 'border-bottom pb-3' : ''}">
                                            <div class="fw-medium text-dark" style="font-size: 0.95rem;">${item.language}</div>
                                            <span class="badge border text-dark fw-normal bg-white rounded-pill px-3">${item.level}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>

                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // NORMAL NODE VIEW
            let html = `<div class="details-content">`;



            // Leader Card
            if (node.leader) {
                html += `
                    <div class="details-card bg-white position-relative overflow-hidden mb-4 p-4 rounded-4 shadow-sm">
                        <div class="d-flex gap-4 align-items-start">
                             <img src="${node.leader.image}" class="rounded-circle" style="width: 96px; height: 96px; object-fit: cover; flex-shrink: 0;">
                             <div class="flex-grow-1">
                                <h3 class="mb-1 fw-semibold" style="font-size: 1.5rem;">${node.leader.name}</h3>
                                <p class="text-muted mb-4" style="font-size: 0.875rem;">${node.leader.title}</p>
                                <div class="p-3 fst-italic mb-4 border-start border-4 border-primary leader-card-message">
                                    ${node.leader.message}
                                </div>
                                <div class="bg-light p-3 rounded-3">
                                     <p class="text-muted text-uppercase mb-2 fw-normal" style="font-size: 0.75rem; letter-spacing: 0.05em;">MISSION STATEMENT</p>
                                     <p class="text-dark mb-0" style="font-size: 0.875rem;">${node.leader.mission}</p>
                                </div>
                             </div>
                        </div>
                    </div>
                `;
            }
            const colors = [
                'bg-primary text-blue-700 bg-opacity-10',
                'bg-purple-100 text-purple-700',
                'bg-green-100 text-green-700',
                'bg-orange-100 text-orange-700',
            ];
            // Overview Section
            if (node.overview) {
                html += `
                    <div class="details-card p-4 rounded-4 shadow-sm">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="d-flex align-items-center justify-content-center rounded-3 bg-blue-50" style="width: 40px; height: 40px; flex-shrink: 0;">
                                <i data-lucide="book-open" class="text-blue-600" style="width: 20px; height: 20px;"></i>
                            </div>
                            <h4 class=" mb-0 fw-semibold">Overview & Responsibilities</h4>
                        </div>
                        <p class="mb-4">${node.overview.description}</p>
                        
                        <p class="text-uppercase text-muted fw-medium mb-3" style="font-size: 0.75rem; letter-spacing: 0.05em;">KEY FOCUS AREAS</p>
                        <div class="d-flex flex-wrap gap-2">
                             ${node.overview.focusAreas.map((area, idx) => {

                    return `<span class="badge ${colors[idx % colors.length]} rounded-pill px-3 py-2 border-0 fw-normal">${area}</span>`
                }).join('')}
                        </div>
                    </div>
                `;
            }

            // Employees Section
            if (node.employees && node.employees.length > 0) {
                html += `
                    <div class="details-card p-4 rounded-4 shadow-sm">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="d-flex align-items-center justify-content-center rounded-3 bg-indigo-50" style="width: 40px; height: 40px; flex-shrink: 0;">
                                <i data-lucide="users" class="text-indigo-600" style="width: 20px; height: 20px;"></i>
                            </div>
                            <h4 class="mb-0 fw-semibold" style="font-size: 1.125rem;">Team Members</h4>
                        </div>
                        <div class="row g-3">
                            ${node.employees.map(emp => `
                                <div class="col-md-6">
                                    <div class="p-3 bg-gray-50 border rounded-3 d-flex align-items-center gap-3 cursor-pointer transition-all" onclick="viewProfile('${emp.id}')" style="background-color: #f9fafb; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.boxShadow='0 1px 3px 0 rgba(0, 0, 0, 0.1)'" onmouseout="this.style.backgroundColor='#f9fafb'; this.style.boxShadow='none'">
                                        <img src="${emp.image}" class="rounded-circle" style="width: 48px; height: 48px; object-fit: cover; flex-shrink: 0;">
                                        <div class="flex-grow-1">
                                            <div class="fw-medium text-dark" style="font-size: 0.875rem;">${emp.name}</div>
                                            <div class="text-muted" style="font-size: 0.75rem;">${emp.role}</div>
                                        </div>
                                        <i data-lucide="chevron-right" class="text-muted" style="width: 16px; height: 16px; flex-shrink: 0;"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Champions (NEW)
            if (node.champions && node.champions.length > 0) {
                html += `
                    <div class="details-card p-0 rounded-4 shadow-sm">
                        <button class="section-header-btn w-100" onclick="toggleSection('champions')">
                             <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center justify-content-center rounded-3 bg-purple-50" style="width: 40px; height: 40px; flex-shrink: 0;">
                                    <i data-lucide="trophy" class="text-purple-600" style="width: 20px; height: 20px;"></i>
                                </div>
                                <div class="text-start">
                                    <h4 class="mb-0 fw-semibold">Department Champions</h4>
                                    <p class="mb-0 text-muted">Specialized role champions across functions</p>
                                </div>
                            </div>
                            <i data-lucide="${state.expandedSections.champions ? 'chevron-up' : 'chevron-down'}" class="text-muted" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                        </button>
                        ${state.expandedSections.champions ? `
                        <div class="p-4 pt-0">
                            <div class="row g-3">
                                ${node.champions.map(champ => `
                                    <div class="col-md-6 col-lg-4 ">
                                        <div class="p-4 bg-light rounded-3 border champion-card">
                                            <div class="d-flex align-items-start gap-3 mb-3">
                                                <img src="${champ.image}" class="rounded-circle" style="width: 48px; height: 48px; object-fit: cover; flex-shrink: 0;">
                                                <div class="flex-grow-1">
                                                    <div class="fw-normal text-black">${champ.name}</div>
                                                    <span class="badge rounded-pill px-3 py-1" style="background-color: ${champ.categoryColor}15; color: ${champ.categoryColor}; border: none; font-size: 0.75rem; font-weight: 500;">${champ.category}</span>
                                                    <p class="mb-0 mt-1 ">${champ.role}</p>
                                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
            }

            // KPIs Section
            if (node.kpis && node.kpis.length > 0) {
                html += `
                    <div class="details-card p-0 rounded-4 shadow-sm">
                        <button class="section-header-btn w-100" onclick="toggleSection('kpis')">
                             <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center justify-content-center rounded-3 bg-blue-50" style="width: 40px; height: 40px; flex-shrink: 0;">
                                    <i data-lucide="activity" class="text-blue-600" style="width: 20px; height: 20px;"></i>
                                </div>
                                <div class="text-start">
                                    <h4 class="mb-0 fw-semibold">Departmental Key Performance Indicators</h4>
                                    <p class="mb-0 fw-normal">Track performance metrics and achievement status</p>
                                </div>
                            </div>
                            <i data-lucide="${state.expandedSections.kpis ? 'chevron-up' : 'chevron-down'}" class="text-muted" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                        </button>
                        ${state.expandedSections.kpis ? `
                        <div class="p-4 pt-0">
                            <div class="d-flex flex-column gap-3">
                                ${node.kpis.map(kpi => `
                                    <div class="p-4 bg-light rounded-3 border">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="d-flex align-items-center gap-2 flex-grow-1">
                                                <h5 class="mb-0 fw-normal text-black">${kpi.title}</h5>
                                                ${kpi.trend === 'up' ? '<i data-lucide="trending-up" class="text-success" style="width: 16px; height: 16px; flex-shrink: 0;"></i>' : ''}
                                                ${kpi.trend === 'down' ? '<i data-lucide="trending-down" class="text-danger" style="width: 16px; height: 16px; flex-shrink: 0;"></i>' : ''}
                                                ${kpi.trend === 'stable' ? '<i data-lucide="minus" class="text-muted" style="width: 16px; height: 16px; flex-shrink: 0;"></i>' : ''}
                                            </div>
                                            <span class="badge fw-normal ${kpi.status === 'exceeds' ? 'bg-green-50 text-green-600 border-green-200' : kpi.status === 'meets' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-orange-50 text-orange-600 border-orange-200'} border px-3 py-1" style="font-size: 0.75rem; font-weight: 500; white-space: nowrap;">
                                                ${kpi.status === 'exceeds' ? 'Exceeds Target' : kpi.status === 'meets' ? 'Meets Target' : 'Below Target'}
                                            </span>
                                        </div>
                                        <p class="text-muted">${kpi.description}</p>
                                        <div class="d-flex gap-4">
                                            <div class="flex-grow-1">
                                                 <p class="text-uppercase fw-normal text-muted mb-1" style="font-size: 0.75rem; letter-spacing: 0.05em;">CURRENT PERFORMANCE</p>
                                                 <p class="fw-normal text-black mb-0" style="font-size: 1.125rem;">${kpi.metric}</p>
                                            </div>
                                            <div style="width: 1px; background: #e5e7eb; align-self: stretch;"></div>
                                            <div class="flex-grow-1">
                                                 <p class="text-muted text-uppercase fw-normal mb-1" style="font-size: 0.75rem; letter-spacing: 0.05em;">TARGET</p>
                                                 <p class="fw-normal text-black mb-0" style="font-size: 1.125rem;">${kpi.target}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
            }

            // Risks (NEW)
            if (node.risks && (node.risks.strategic || node.risks.operational)) {
                html += `
                    <div class="details-card p-0 rounded-4 shadow-sm">
                         <button class="section-header-btn w-100" onclick="toggleSection('risks')">
                             <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center justify-content-center rounded-3 bg-red-50" style="width: 40px; height: 40px; flex-shrink: 0;">
                                    <i data-lucide="alert-triangle" class="text-red-600" style="width: 20px; height: 20px;"></i>
                                </div>
                                <div class="text-start">
                                    <h4 class="mb-0 fw-semibold">Departmental Risks</h4>
                                    <p class="mb-0 text-muted">Strategic and operational risk assessment</p>
                                </div>
                            </div>
                            <i data-lucide="${state.expandedSections.risks ? 'chevron-up' : 'chevron-down'}" class="text-muted" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                        </button>
                        ${state.expandedSections.risks ? `
                        <div class="p-4 pt-0">
                            ${node.risks.strategic ? `
                                <div class="mb-3">
                                    <div class="d-flex align-items-center gap-2 mb-3">
                                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-purple-50" style="width: 32px; height: 32px; flex-shrink: 0;">
                                            <i data-lucide="target" class="text-purple-600" style="width: 16px; height: 16px;"></i>
                                        </div>
                                        <span class="fw-normal fs-5">Strategic Risks</span>
                                    </div>
                                    ${node.risks.strategic.map(r => `
                                        <div class="p-3 bg-light rounded-3 border mb-3" style="border-color: #e5e7eb !important;">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <span class="fw-normal text-dark">${r.title}</span>
                                                <span class="badge fw-normal px-3 py-1" style="background-color: #FEF2F2; color: #c10007; border: 1px solid #ffc9c9;">${r.level} Risk</span>
                                            </div>
                                            <p class="text-muted mb-3">${r.description}</p>
                                            <div class="bg-white border p-3 rounded-3">
                                                <div class="text-muted text-uppercase fw-normal fs-6">MITIGATION STRATEGY</div>
                                                <div class="fw-normal text-dark fs-6">${r.mitigationRole || r.mitigation}</div>
                                                ${r.mitigationRole ? `<div class="text-muted fs-6">${r.mitigation}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            ${node.risks.operational ? `
                                <div class="mb-0">
                                    <div class="d-flex align-items-center gap-2 mb-3">
                                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-blue-50" style="width: 32px; height: 32px; flex-shrink: 0;">
                                            <i data-lucide="settings" class="text-blue-600" style="width: 16px; height: 16px;"></i>
                                        </div>
                                        <span class="fw-semibold">Operational Risks</span>
                                    </div>
                                    ${node.risks.operational.map(r => `
                                        <div class="p-3 bg-light rounded-3 border mb-3" style="border-color: #e5e7eb !important;">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <span class="fw-semibold text-dark">${r.title}</span>
                                                <span class="badge fw-normal px-3 py-1" style="background-color: #FFF7ED; color: #ca3500; border: 1px solid #ffd7a8;">${r.level} Risk</span>
                                            </div>
                                            <p class="text-muted mb-3">${r.description}</p>
                                            <div class="bg-white border p-3 rounded-3">
                                                <div class="text-muted text-uppercase fw-normal fs-6">MITIGATION STRATEGY</div>
                                                <div class="fw-normal text-dark fs-6">${r.mitigationRole || r.mitigation}</div>
                                                ${r.mitigationRole ? `<div class="text-muted fs-6">${r.mitigation}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>` : ''}
                    </div>
                `;
            }

            // Committees (NEW)
            if (node.committees && node.committees.length > 0) {
                html += `
                    <div class="details-card p-0 rounded-4 shadow-sm">
                         <button class="section-header-btn w-100" onclick="toggleSection('committees')">
                             <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center justify-content-center rounded-3 bg-green-50" style="width: 40px; height: 40px; flex-shrink: 0;">
                                    <i data-lucide="users-2" class="text-green-600" style="width: 20px; height: 20px;"></i>
                                </div>
                                <div class="text-start">
                                    <h4 class="mb-0 fw-semibold">Committees and Teams</h4>
                                    <p class="mb-0 text-muted">Cross-functional committees and working groups</p>
                                </div>
                            </div>
                            <i data-lucide="${state.expandedSections.committees ? 'chevron-up' : 'chevron-down'}" class="text-muted" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                        </button>
                        ${state.expandedSections.committees ? `
                        <div class="p-4 pt-0">
                            <div class="d-flex flex-column gap-3">
                                ${node.committees.map(c => `
                                    <div class="p-4 bg-light rounded-3 border">
                                        <h5 class="fw-semibold text-dark mb-2">${c.name}</h5>
                                        <p class="text-muted mb-3">${c.purpose}</p>
                                        <div class="d-flex flex-column gap-2 mb-3">
                                            <div class="d-flex gap-2 align-items-center">
                                                <i data-lucide="crown" class="text-purple-600" style="width: 14px; height: 14px; flex-shrink: 0;"></i>
                                                <span class="text-muted">Chairperson:</span>
                                                <span class="text-dark fw-medium">${c.chairperson}</span>
                                            </div>
                                            <div class="d-flex gap-2 align-items-center">
                                                <i data-lucide="user-cog" class="text-blue-600" style="width: 14px; height: 14px; flex-shrink: 0;"></i>
                                                <span class="text-muted">Coordinator:</span>
                                                <span class="text-dark fw-medium">${c.coordinator}</span>
                                            </div>
                                        </div>
                                        ${c.members && c.members.length > 0 ? `
                                            <div class="border-top pt-3">
                                                <p class="text-muted text-uppercase fw-medium mb-2" style="font-size: 0.75rem; letter-spacing: 0.05em;">COMMITTEE MEMBERS</p>
                                                <div class="row g-2">
                                                    ${c.members.map(m => `
                                                        <div class="col-md-6 d-flex gap-2 align-items-center" style="font-size: 0.75rem;">
                                                            <i data-lucide="user" class="text-muted" style="width: 12px; height: 12px; flex-shrink: 0;"></i>
                                                            <span class="text-dark fw-medium">${m.name}</span>
                                                            <span class="text-muted">- ${m.role}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `: ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
            }

            // Empty state for nodes without data
            if (!node.leader && !node.overview && (!node.employees || node.employees.length === 0)) {
                html += `
                    <div class="details-card p-5 text-center rounded-4 shadow-sm">
                        <div class="d-flex justify-content-center mb-4">
                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                <i data-lucide="building-2" class="text-secondary" style="width: 32px; height: 32px;"></i>
                            </div>
                        </div>
                        <h3 class="text-dark mb-2">${node.title}</h3>
                        <p class="text-muted small mx-auto" style="max-width: 500px;">
                            Detailed information for this organizational unit will be available soon.
                        </p>
                    </div>
                `;
            }

            html += `</div>`; // End Details Content
            panel.innerHTML = html;
            lucide.createIcons();
        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            renderTree();
        });

    </script>
</body>

</html>